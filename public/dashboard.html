<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dev Dashboard - Multi-Project Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .workflow-arrow::after {
            content: '‚Üí';
            margin: 0 10px;
            color: #9CA3AF;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <h1 class="text-2xl font-bold text-gray-900">üöÄ Dev Dashboard</h1>
                    <select id="projectSelector" class="px-4 py-2 border rounded-lg bg-white">
                        <option value="">Loading projects...</option>
                    </select>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="sessionCount" class="text-sm text-gray-600"></span>
                    <button onclick="loadData()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                        Refresh
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Workflow Indicator -->
    <div class="bg-blue-50 border-b border-blue-200">
        <div class="max-w-7xl mx-auto px-4 py-2">
            <div class="flex items-center text-sm text-blue-700">
                <span class="font-medium">Workflow:</span>
                <span class="workflow-arrow ml-2">Ideas</span>
                <span class="workflow-arrow">Sprints</span>
                <span class="workflow-arrow">Worktrees</span>
                <span class="ml-2">Sessions</span>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-8">
        <!-- Tabs -->
        <div class="border-b border-gray-200 mb-8">
            <nav class="-mb-px flex space-x-8">
                <button onclick="switchTab('overview')" class="tab-btn py-2 px-1 border-b-2 font-medium text-sm border-blue-500 text-blue-600">
                    Overview
                </button>
                <button onclick="switchTab('ideas')" class="tab-btn py-2 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700">
                    Ideas & Issues
                </button>
                <button onclick="switchTab('sprints')" class="tab-btn py-2 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700">
                    Sprints
                </button>
                <button onclick="switchTab('worktrees')" class="tab-btn py-2 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700">
                    Worktrees
                </button>
                <button onclick="switchTab('sessions')" class="tab-btn py-2 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700">
                    Sessions
                </button>
            </nav>
        </div>

        <!-- Tab Content -->
        <div id="overview" class="tab-content active">
            <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-4 gap-6">
                <!-- Project Info Card -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-lg font-semibold mb-4">Current Project</h2>
                    <div id="projectInfo" class="space-y-2 text-sm">
                        <p class="text-gray-500">Select a project to view details</p>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-lg font-semibold mb-4">Issues</h2>
                    <div id="issueStats" class="space-y-2">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Total:</span>
                            <span class="font-bold">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Backlog:</span>
                            <span>0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">In Sprints:</span>
                            <span>0</span>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-lg font-semibold mb-4">Sprints</h2>
                    <div id="sprintStats" class="space-y-2">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Active:</span>
                            <span class="font-bold">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Planned:</span>
                            <span>0</span>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-lg font-semibold mb-4">Worktrees</h2>
                    <div id="worktreeStats" class="space-y-2">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Active:</span>
                            <span class="font-bold">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">With Sprints:</span>
                            <span>0</span>
                        </div>
                    </div>
                </div>

                <!-- Active Sessions (full width) -->
                <div class="bg-white rounded-lg shadow p-6 lg:col-span-2 xl:col-span-4">
                    <h2 class="text-lg font-semibold mb-4">Active Sessions</h2>
                    <div id="activeSessions" class="space-y-3">
                        <p class="text-gray-500 text-sm">Loading sessions...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ideas & Issues Tab -->
        <div id="ideas" class="tab-content">
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-semibold">üìã Issues & Ideas Registry</h2>
                    <button onclick="showCreateIdea()" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 text-sm">
                        + New Issue/Idea
                    </button>
                </div>
                <div id="ideasList" class="space-y-3">
                    <p class="text-gray-500">Loading issues...</p>
                </div>
            </div>
        </div>

        <!-- Sprints Tab -->
        <div id="sprints" class="tab-content">
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-semibold">üéØ Sprint Management</h2>
                    <button onclick="showCreateSprint()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 text-sm">
                        + New Sprint
                    </button>
                </div>
                <div id="sprintsList" class="space-y-4">
                    <p class="text-gray-500">Loading sprints...</p>
                </div>
            </div>
        </div>

        <!-- Worktrees Tab -->
        <div id="worktrees" class="tab-content">
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-semibold">üå≥ Worktree Management</h2>
                    <button onclick="showCreateWorktree()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 text-sm">
                        + New Worktree
                    </button>
                </div>
                <div id="worktreesList" class="space-y-4">
                    <p class="text-gray-500">Loading worktrees...</p>
                </div>
            </div>
        </div>

        <!-- Sessions Tab -->
        <div id="sessions" class="tab-content">
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-semibold">üìù Session Management</h2>
                    <button onclick="showCreateSession()" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 text-sm">
                        + New Session
                    </button>
                </div>
                <div id="sessionsList" class="space-y-3">
                    <p class="text-gray-500">Loading sessions...</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Modals -->
    <div id="modalOverlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div id="modalContent" class="bg-white rounded-lg p-6 max-w-md w-full mx-4 max-h-[80vh] overflow-y-auto">
            <!-- Modal content will be inserted here -->
        </div>
    </div>

    <script>
        let projects = {};
        let activeProject = null;
        let sessions = [];
        let ideas = {};
        let worktrees = [];
        let sprintAssignments = {}; // Track which sprints are assigned to which worktrees

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
        });

        async function loadData() {
            try {
                // Load projects
                const projectsRes = await fetch('/api/projects');
                const projectsData = await projectsRes.json();
                projects = projectsData.projects;
                activeProject = projectsData.activeProject;
                
                // Update project selector
                const selector = document.getElementById('projectSelector');
                selector.innerHTML = Object.entries(projects).map(([id, project]) => 
                    `<option value="${id}" ${id === activeProject ? 'selected' : ''}>
                        ${project.icon} ${project.name}
                    </option>`
                ).join('');
                
                // Load sessions
                const sessionsRes = await fetch('/api/sessions');
                sessions = await sessionsRes.json();
                
                // Update session count
                const activeCount = sessions.filter(s => s.status === 'ready' || s.status === 'active').length;
                document.getElementById('sessionCount').textContent = `${activeCount} active sessions`;
                
                // Load current project data
                if (activeProject) {
                    await loadProjectData(activeProject);
                }
                
                // Update all views
                updateOverview();
                updateIssues();
                updateSprints();
                updateWorktrees();
                updateSessions();
                
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        async function loadProjectData(projectId) {
            if (!projectId) return;
            
            try {
                // Load ideas/sprints
                const ideasRes = await fetch(`/api/projects/${projectId}/ideas`);
                ideas = await ideasRes.json();
                
                // Load worktrees
                const worktreesRes = await fetch(`/api/projects/${projectId}/worktrees`);
                worktrees = await worktreesRes.json();
                
                // Load sprint assignments from localStorage (or could be from server)
                const stored = localStorage.getItem(`sprint-assignments-${projectId}`);
                sprintAssignments = stored ? JSON.parse(stored) : {};
                
            } catch (error) {
                console.error('Error loading project data:', error);
            }
        }

        function updateOverview() {
            const project = projects[activeProject];
            if (!project) return;
            
            // Update project info
            document.getElementById('projectInfo').innerHTML = `
                <div class="space-y-3">
                    <div class="flex items-center space-x-2">
                        <span class="text-2xl">${project.icon}</span>
                        <div>
                            <p class="font-semibold">${project.name}</p>
                            <p class="text-gray-600 text-xs">${project.description}</p>
                        </div>
                    </div>
                </div>
            `;
            
            // Update stats
            const allItems = ideas.items || [];
            const backlogItems = allItems.filter(i => !i.sprint || i.sprint === 'backlog');
            const sprints = Object.keys(ideas.sprints || {});
            const activeSprints = sprints.filter(s => ideas.sprints[s].status === 'active');
            
            document.getElementById('issueStats').innerHTML = `
                <div class="flex justify-between">
                    <span class="text-gray-600">Total:</span>
                    <span class="font-bold">${allItems.length}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Backlog:</span>
                    <span>${backlogItems.length}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">In Sprints:</span>
                    <span>${allItems.length - backlogItems.length}</span>
                </div>
            `;
            
            document.getElementById('sprintStats').innerHTML = `
                <div class="flex justify-between">
                    <span class="text-gray-600">Total:</span>
                    <span class="font-bold">${sprints.length}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Active:</span>
                    <span>${activeSprints.length}</span>
                </div>
            `;
            
            const worktreesWithSprints = worktrees.filter(w => 
                Object.values(sprintAssignments).some(a => a.worktree === w.name)
            );
            
            document.getElementById('worktreeStats').innerHTML = `
                <div class="flex justify-between">
                    <span class="text-gray-600">Total:</span>
                    <span class="font-bold">${worktrees.length}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">With Sprints:</span>
                    <span>${worktreesWithSprints.length}</span>
                </div>
            `;
            
            // Update active sessions
            const activeSessions = sessions.filter(s => 
                s.projectId === activeProject && (s.status === 'ready' || s.status === 'active')
            );
            
            document.getElementById('activeSessions').innerHTML = activeSessions.length > 0 
                ? activeSessions.map(session => `
                    <div class="border rounded-lg p-4 hover:bg-gray-50">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-medium">${session.sprint}</p>
                                <p class="text-sm text-gray-600 mt-1">
                                    Worktree: ${session.worktree} ‚Ä¢ ${session.items} items
                                </p>
                            </div>
                            <button onclick="viewSessionPrompt('${session.sessionId}')" 
                                class="px-2 py-1 text-xs bg-blue-500 text-white rounded hover:bg-blue-600">
                                View Prompt
                            </button>
                        </div>
                    </div>
                `).join('')
                : '<p class="text-gray-500 text-sm">No active sessions</p>';
        }

        function updateIssues() {
            const allItems = ideas.items || [];
            
            document.getElementById('ideasList').innerHTML = allItems.length > 0 ? `
                <div class="mb-4 flex gap-2">
                    <span class="px-2 py-1 text-xs bg-gray-100 rounded">
                        Total: ${allItems.length}
                    </span>
                    <span class="px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded">
                        Backlog: ${allItems.filter(i => !i.sprint || i.sprint === 'backlog').length}
                    </span>
                </div>
                ${allItems.map(item => `
                    <div class="border rounded-lg p-3 hover:bg-gray-50">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="px-2 py-1 text-xs font-medium ${
                                        item.type === 'bug' ? 'bg-red-100 text-red-800' :
                                        item.type === 'feature' ? 'bg-purple-100 text-purple-800' :
                                        item.type === 'task' ? 'bg-blue-100 text-blue-800' :
                                        'bg-gray-100 text-gray-800'
                                    } rounded">${item.type}</span>
                                    <span class="text-xs font-mono text-gray-500">${item.id}</span>
                                    <span class="px-2 py-1 text-xs ${
                                        item.priority === 'critical' ? 'bg-red-100 text-red-800' :
                                        item.priority === 'high' ? 'bg-orange-100 text-orange-800' :
                                        item.priority === 'medium' ? 'bg-yellow-100 text-yellow-800' :
                                        'bg-gray-100 text-gray-800'
                                    } rounded">${item.priority}</span>
                                </div>
                                <p class="font-medium text-sm">${item.title}</p>
                                <p class="text-xs text-gray-600 mt-1">${item.description?.substring(0, 100)}...</p>
                                <div class="flex items-center gap-3 mt-2">
                                    <span class="text-xs text-gray-500">
                                        Sprint: <span class="font-medium">${item.sprint || 'backlog'}</span>
                                    </span>
                                </div>
                            </div>
                            <div class="flex flex-col gap-1">
                                <button onclick="moveToSprint('${item.id}')" 
                                    class="px-2 py-1 text-xs bg-blue-500 text-white rounded hover:bg-blue-600">
                                    Assign Sprint
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('')}
            ` : '<p class="text-gray-500">No issues or ideas yet</p>';
        }

        function updateSprints() {
            if (!ideas.sprints) {
                document.getElementById('sprintsList').innerHTML = '<p class="text-gray-500">No sprints yet</p>';
                return;
            }
            
            document.getElementById('sprintsList').innerHTML = Object.entries(ideas.sprints).map(([name, sprint]) => {
                const items = ideas.items?.filter(i => i.sprint === name) || [];
                const todoItems = items.filter(i => i.status !== 'done');
                const assignment = sprintAssignments[name];
                
                return `
                    <div class="border rounded-lg p-4">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <p class="font-medium text-lg">${name}</p>
                                <p class="text-sm text-gray-600 mt-1">${sprint.description || 'No description'}</p>
                                <div class="flex gap-3 mt-2">
                                    <span class="text-xs text-gray-600">
                                        üìù Todo: <span class="font-bold">${todoItems.length}</span>
                                    </span>
                                    <span class="text-xs text-gray-600">
                                        üìä Total: <span class="font-bold">${items.length}</span>
                                    </span>
                                </div>
                                ${assignment ? `
                                    <div class="mt-2 p-2 bg-green-50 rounded">
                                        <span class="text-xs text-green-700">
                                            ‚úÖ Assigned to worktree: <strong>${assignment.worktree}</strong>
                                        </span>
                                    </div>
                                ` : `
                                    <div class="mt-2 p-2 bg-yellow-50 rounded">
                                        <span class="text-xs text-yellow-700">
                                            ‚ö†Ô∏è Not assigned to any worktree
                                        </span>
                                    </div>
                                `}
                            </div>
                            <div class="flex flex-col gap-1">
                                <button onclick="assignSprintToWorktree('${name}')" 
                                    class="px-3 py-1 text-sm bg-blue-500 text-white rounded hover:bg-blue-600">
                                    ${assignment ? 'Reassign' : 'Assign'} Worktree
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateWorktrees() {
            document.getElementById('worktreesList').innerHTML = worktrees.length > 0
                ? worktrees.map(wt => {
                    // Find sprints assigned to this worktree
                    const assignedSprints = Object.entries(sprintAssignments)
                        .filter(([sprint, assignment]) => assignment.worktree === wt.name)
                        .map(([sprint]) => sprint);
                    
                    return `
                        <div class="border rounded-lg p-4">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <p class="font-medium text-lg">${wt.name}</p>
                                    <p class="text-sm text-gray-600">${wt.description || 'No description'}</p>
                                    <div class="mt-2 space-y-1 text-xs">
                                        <div>Frontend: localhost:${wt.frontendPort || '?'}</div>
                                        <div>Backend: localhost:${wt.backendPort || '?'}</div>
                                    </div>
                                    ${assignedSprints.length > 0 ? `
                                        <div class="mt-3 p-2 bg-blue-50 rounded">
                                            <p class="text-xs font-medium text-blue-700 mb-1">Assigned Sprints:</p>
                                            ${assignedSprints.map(s => `
                                                <span class="inline-block px-2 py-1 text-xs bg-white rounded mr-1 mb-1">
                                                    ${s}
                                                </span>
                                            `).join('')}
                                        </div>
                                    ` : `
                                        <div class="mt-3 p-2 bg-gray-50 rounded">
                                            <p class="text-xs text-gray-600">No sprints assigned</p>
                                        </div>
                                    `}
                                </div>
                                <div class="flex flex-col gap-1">
                                    ${assignedSprints.length > 0 ? `
                                        <button onclick="createSessionForWorktree('${wt.name}')" 
                                            class="px-3 py-1 text-sm bg-green-500 text-white rounded hover:bg-green-600">
                                            Create Session
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('')
                : '<p class="text-gray-500">No worktrees yet</p>';
        }

        function updateSessions() {
            const projectSessions = sessions.filter(s => s.projectId === activeProject);
            
            document.getElementById('sessionsList').innerHTML = projectSessions.length > 0
                ? projectSessions.map(session => `
                    <div class="border rounded-lg p-4 hover:bg-gray-50">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-medium text-sm">${session.sessionId}</p>
                                <p class="text-sm text-gray-600 mt-1">
                                    Sprint: ${session.sprint} ‚Ä¢ Worktree: ${session.worktree}
                                </p>
                                <p class="text-xs text-gray-500 mt-1">
                                    ${session.items} items ‚Ä¢ ${new Date(session.created).toLocaleString()}
                                </p>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="px-2 py-1 text-xs ${
                                    session.status === 'completed' ? 'bg-green-100 text-green-800' :
                                    session.status === 'active' ? 'bg-blue-100 text-blue-800' :
                                    'bg-gray-100 text-gray-800'
                                } rounded">
                                    ${session.status}
                                </span>
                                <button onclick="viewSessionPrompt('${session.sessionId}')" 
                                    class="px-2 py-1 text-xs bg-blue-500 text-white rounded hover:bg-blue-600">
                                    Prompt
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('')
                : '<p class="text-gray-500 text-sm">No sessions yet</p>';
        }

        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('border-blue-500', 'text-blue-600');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            event.target.classList.remove('border-transparent', 'text-gray-500');
            event.target.classList.add('border-blue-500', 'text-blue-600');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');
        }

        // Project selector change
        document.getElementById('projectSelector').addEventListener('change', async (e) => {
            const projectId = e.target.value;
            if (projectId && projectId !== activeProject) {
                await fetch('/api/projects/select', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ projectId })
                });
                activeProject = projectId;
                await loadData();
            }
        });

        // Modal functions
        function showModal(content) {
            document.getElementById('modalContent').innerHTML = content;
            document.getElementById('modalOverlay').classList.remove('hidden');
        }

        function hideModal() {
            document.getElementById('modalOverlay').classList.add('hidden');
        }

        function assignSprintToWorktree(sprintName) {
            if (worktrees.length === 0) {
                alert('Please create a worktree first');
                return;
            }
            
            const currentAssignment = sprintAssignments[sprintName];
            
            showModal(`
                <h3 class="text-lg font-semibold mb-4">Assign Sprint to Worktree</h3>
                <p class="text-sm text-gray-600 mb-4">Sprint: <strong>${sprintName}</strong></p>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Select Worktree</label>
                        <select id="worktreeSelect" class="w-full px-3 py-2 border rounded">
                            <option value="">-- Select Worktree --</option>
                            ${worktrees.map(wt => `
                                <option value="${wt.name}" ${currentAssignment?.worktree === wt.name ? 'selected' : ''}>
                                    ${wt.name} (Frontend: ${wt.frontendPort}, Backend: ${wt.backendPort})
                                </option>
                            `).join('')}
                        </select>
                    </div>
                    <div class="flex justify-end space-x-2">
                        <button onclick="hideModal()" class="px-4 py-2 border rounded hover:bg-gray-50">
                            Cancel
                        </button>
                        <button onclick="saveSprintAssignment('${sprintName}')" 
                            class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                            Assign
                        </button>
                    </div>
                </div>
            `);
        }

        function saveSprintAssignment(sprintName) {
            const worktreeName = document.getElementById('worktreeSelect').value;
            if (!worktreeName) {
                alert('Please select a worktree');
                return;
            }
            
            sprintAssignments[sprintName] = {
                worktree: worktreeName,
                assignedAt: new Date().toISOString()
            };
            
            // Save to localStorage
            localStorage.setItem(`sprint-assignments-${activeProject}`, JSON.stringify(sprintAssignments));
            
            hideModal();
            updateSprints();
            updateWorktrees();
            alert(`Sprint "${sprintName}" assigned to worktree "${worktreeName}"`);
        }

        function createSessionForWorktree(worktreeName) {
            // Find sprints assigned to this worktree
            const assignedSprints = Object.entries(sprintAssignments)
                .filter(([sprint, assignment]) => assignment.worktree === worktreeName)
                .map(([sprint]) => sprint);
            
            if (assignedSprints.length === 0) {
                alert('No sprints assigned to this worktree');
                return;
            }
            
            let selectedSprint = assignedSprints[0];
            if (assignedSprints.length > 1) {
                selectedSprint = prompt(`Select sprint for session:\n\n${assignedSprints.join('\n')}`);
                if (!selectedSprint || !assignedSprints.includes(selectedSprint)) {
                    return;
                }
            }
            
            createSession(selectedSprint, worktreeName);
        }

        async function createSession(sprintName, worktreeName) {
            if (!sprintName || !worktreeName) {
                alert('Sprint and worktree are required');
                return;
            }
            
            try {
                const res = await fetch('/api/sessions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        projectId: activeProject,
                        sprintName: sprintName,
                        worktreeName: worktreeName
                    })
                });
                
                const data = await res.json();
                if (data.success) {
                    await loadData();
                    alert(`Session created! ID: ${data.session.sessionId}`);
                    
                    if (confirm('View session prompt?')) {
                        viewSessionPrompt(data.session.sessionId);
                    }
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Failed to create session: ' + error.message);
            }
        }

        function showCreateSession() {
            // Get sprints with worktree assignments
            const assignedSprints = Object.entries(sprintAssignments)
                .map(([sprint, assignment]) => ({ sprint, worktree: assignment.worktree }));
            
            if (assignedSprints.length === 0) {
                alert('Please assign a sprint to a worktree first');
                return;
            }
            
            showModal(`
                <h3 class="text-lg font-semibold mb-4">Create New Session</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Select Sprint & Worktree</label>
                        <select id="sessionConfig" class="w-full px-3 py-2 border rounded">
                            ${assignedSprints.map(config => `
                                <option value="${config.sprint}|${config.worktree}">
                                    ${config.sprint} ‚Üí ${config.worktree}
                                </option>
                            `).join('')}
                        </select>
                    </div>
                    <div class="flex justify-end space-x-2">
                        <button onclick="hideModal()" class="px-4 py-2 border rounded hover:bg-gray-50">
                            Cancel
                        </button>
                        <button onclick="createSessionFromModal()" 
                            class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
                            Create Session
                        </button>
                    </div>
                </div>
            `);
        }

        function createSessionFromModal() {
            const config = document.getElementById('sessionConfig').value;
            const [sprint, worktree] = config.split('|');
            hideModal();
            createSession(sprint, worktree);
        }

        function showCreateIdea() {
            if (!activeProject) {
                alert('Please select a project first');
                return;
            }
            
            showModal(`
                <h3 class="text-lg font-semibold mb-4">Create New Issue/Idea</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Type</label>
                        <select id="itemType" class="w-full px-3 py-2 border rounded">
                            <option value="bug">Bug</option>
                            <option value="feature">Feature</option>
                            <option value="task">Task</option>
                            <option value="idea">Idea</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Title</label>
                        <input id="itemTitle" type="text" class="w-full px-3 py-2 border rounded" 
                            placeholder="Brief description">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Description</label>
                        <textarea id="itemDesc" class="w-full px-3 py-2 border rounded" rows="3"
                            placeholder="Detailed description"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Priority</label>
                        <select id="itemPriority" class="w-full px-3 py-2 border rounded">
                            <option value="low">Low</option>
                            <option value="medium" selected>Medium</option>
                            <option value="high">High</option>
                            <option value="critical">Critical</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Sprint</label>
                        <select id="itemSprint" class="w-full px-3 py-2 border rounded">
                            <option value="backlog">Backlog</option>
                            ${Object.keys(ideas.sprints || {}).map(s => 
                                `<option value="${s}">${s}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div class="flex justify-end space-x-2">
                        <button onclick="hideModal()" class="px-4 py-2 border rounded hover:bg-gray-50">
                            Cancel
                        </button>
                        <button onclick="createIdea()" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
                            Create Issue
                        </button>
                    </div>
                </div>
            `);
        }

        async function createIdea() {
            const type = document.getElementById('itemType').value;
            const title = document.getElementById('itemTitle').value;
            const desc = document.getElementById('itemDesc').value;
            const priority = document.getElementById('itemPriority').value;
            const sprint = document.getElementById('itemSprint').value;
            
            if (!title) {
                alert('Please enter a title');
                return;
            }
            
            if (!ideas.items) ideas.items = [];
            
            // Generate ID
            const typePrefix = type === 'bug' ? 'bug' : type === 'feature' ? 'feature' : type === 'task' ? 'task' : 'idea';
            const nextNum = ideas.items.filter(i => i.id?.startsWith(typePrefix)).length + 1;
            const id = `${typePrefix}-${String(nextNum).padStart(3, '0')}`;
            
            const newItem = {
                id,
                type,
                title,
                description: desc,
                priority,
                sprint,
                status: 'new',
                created: new Date().toISOString(),
                updated: new Date().toISOString()
            };
            
            ideas.items.push(newItem);
            
            try {
                await fetch(`/api/projects/${activeProject}/ideas`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(ideas)
                });
                
                hideModal();
                updateIssues();
                updateSprints();
                updateOverview();
                alert(`Created ${type}: ${id}`);
            } catch (error) {
                alert('Failed to create item: ' + error.message);
            }
        }

        function showCreateSprint() {
            if (!activeProject) {
                alert('Please select a project first');
                return;
            }
            
            showModal(`
                <h3 class="text-lg font-semibold mb-4">Create New Sprint</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Sprint Name</label>
                        <input id="sprintName" type="text" class="w-full px-3 py-2 border rounded" 
                            placeholder="Sprint 1">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Description</label>
                        <input id="sprintDesc" type="text" class="w-full px-3 py-2 border rounded" 
                            placeholder="Optional description">
                    </div>
                    <div class="flex justify-end space-x-2">
                        <button onclick="hideModal()" class="px-4 py-2 border rounded hover:bg-gray-50">
                            Cancel
                        </button>
                        <button onclick="createSprint()" class="px-4 py-2 bg-purple-500 text-white rounded hover:bg-purple-600">
                            Create Sprint
                        </button>
                    </div>
                </div>
            `);
        }

        async function createSprint() {
            const name = document.getElementById('sprintName').value;
            const desc = document.getElementById('sprintDesc').value;
            
            if (!name) {
                alert('Please enter a sprint name');
                return;
            }
            
            if (!ideas.sprints) ideas.sprints = {};
            
            ideas.sprints[name] = {
                name: name,
                description: desc,
                status: 'active',
                created: new Date().toISOString()
            };
            
            try {
                await fetch(`/api/projects/${activeProject}/ideas`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(ideas)
                });
                
                hideModal();
                updateSprints();
                updateOverview();
                alert('Sprint created!');
            } catch (error) {
                alert('Failed to create sprint: ' + error.message);
            }
        }

        function showCreateWorktree() {
            if (!activeProject) {
                alert('Please select a project first');
                return;
            }
            
            showModal(`
                <h3 class="text-lg font-semibold mb-4">Create New Worktree</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Branch Name</label>
                        <input id="worktreeName" type="text" class="w-full px-3 py-2 border rounded" 
                            placeholder="feature/my-feature">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Description</label>
                        <input id="worktreeDesc" type="text" class="w-full px-3 py-2 border rounded" 
                            placeholder="Optional description">
                    </div>
                    <div class="flex justify-end space-x-2">
                        <button onclick="hideModal()" class="px-4 py-2 border rounded hover:bg-gray-50">
                            Cancel
                        </button>
                        <button onclick="createWorktree()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                            Create Worktree
                        </button>
                    </div>
                </div>
            `);
        }

        async function createWorktree() {
            const name = document.getElementById('worktreeName').value;
            const desc = document.getElementById('worktreeDesc').value;
            
            if (!name) {
                alert('Please enter a branch name');
                return;
            }
            
            try {
                const res = await fetch(`/api/projects/${activeProject}/worktrees`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        branchName: name,
                        description: desc
                    })
                });
                
                const data = await res.json();
                if (data.success) {
                    hideModal();
                    await loadProjectData(activeProject);
                    updateWorktrees();
                    alert(`Worktree created! Frontend: ${data.worktree.frontendPort}, Backend: ${data.worktree.backendPort}`);
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Failed to create worktree: ' + error.message);
            }
        }

        function moveToSprint(itemId) {
            const item = ideas.items.find(i => i.id === itemId);
            if (!item) return;
            
            const sprints = ['backlog', ...Object.keys(ideas.sprints || {})];
            const newSprint = prompt(`Move "${item.title}" to sprint:\n\n${sprints.join('\n')}\n\nEnter sprint name:`);
            
            if (!newSprint || !sprints.includes(newSprint)) {
                return;
            }
            
            item.sprint = newSprint;
            item.updated = new Date().toISOString();
            
            fetch(`/api/projects/${activeProject}/ideas`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(ideas)
            }).then(() => {
                updateIssues();
                updateSprints();
                alert(`Moved to ${newSprint}`);
            });
        }

        async function viewSessionPrompt(sessionId) {
            try {
                const res = await fetch(`/api/sessions/${sessionId}/prompt`);
                const prompt = await res.text();
                
                showModal(`
                    <div class="max-h-96 overflow-y-auto">
                        <h3 class="text-lg font-semibold mb-4 sticky top-0 bg-white">Session Prompt</h3>
                        <pre class="text-xs whitespace-pre-wrap font-mono bg-gray-50 p-4 rounded">${prompt}</pre>
                        <div class="flex justify-end space-x-2 mt-4 sticky bottom-0 bg-white pt-2">
                            <button onclick="hideModal()" class="px-4 py-2 border rounded hover:bg-gray-50">
                                Close
                            </button>
                            <button onclick="copyPrompt('${sessionId}')" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                                Copy to Clipboard
                            </button>
                        </div>
                    </div>
                `);
            } catch (error) {
                alert('Failed to load prompt: ' + error.message);
            }
        }

        async function copyPrompt(sessionId) {
            try {
                const res = await fetch(`/api/sessions/${sessionId}/prompt`);
                const prompt = await res.text();
                await navigator.clipboard.writeText(prompt);
                alert('Prompt copied to clipboard!');
            } catch (error) {
                alert('Failed to copy prompt: ' + error.message);
            }
        }

        // Close modal when clicking overlay
        document.getElementById('modalOverlay').addEventListener('click', (e) => {
            if (e.target.id === 'modalOverlay') {
                hideModal();
            }
        });
    </script>
</body>
</html>