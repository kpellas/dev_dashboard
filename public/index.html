<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dev Dashboard - Multi-Project Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="session-management.js" defer></script>
    <script src="session-enhanced.js" defer></script>
    <script src="session-verification.js" defer></script>
    <script src="session-auto-verify.js" defer></script>
    <script src="dashboard-improvements.js" defer></script>
    <style>
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .workflow-arrow::after {
            content: '→';
            margin: 0 10px;
            color: #9CA3AF;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <h1 class="text-2xl font-bold text-gray-900">Dev Dashboard</h1>
                    <select id="projectSelector" class="px-4 py-2 border rounded-lg bg-white">
                        <option value="">Loading projects...</option>
                    </select>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="sessionCount" class="text-sm text-gray-600"></span>
                    <button onclick="loadData()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                        Refresh
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Workflow Indicator -->
    <div class="bg-blue-50 border-b border-blue-200">
        <div class="max-w-7xl mx-auto px-4 py-2">
            <div class="flex items-center text-sm text-blue-700">
                <span class="font-medium">Workflow:</span>
                <span class="workflow-arrow ml-2">Ideas</span>
                <span class="workflow-arrow">Sprints</span>
                <span class="workflow-arrow">Worktrees</span>
                <span class="ml-2">Sessions</span>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-8">
        <!-- Tabs -->
        <div class="border-b border-gray-200 mb-8">
            <nav class="-mb-px flex space-x-8">
                <button onclick="switchTab('overview')" class="tab-btn py-2 px-1 border-b-2 font-medium text-sm border-blue-500 text-blue-600">
                    Overview
                </button>
                <button onclick="switchTab('ideas')" class="tab-btn py-2 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700">
                    Ideas & Issues
                </button>
                <button onclick="switchTab('sprints')" class="tab-btn py-2 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700">
                    Sprints
                </button>
                <button onclick="switchTab('worktrees')" class="tab-btn py-2 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700">
                    Worktrees
                </button>
                <button onclick="switchTab('sessions')" class="tab-btn py-2 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700">
                    Sessions
                </button>
                <button onclick="switchTab('branches')" class="tab-btn py-2 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700">
                    Branches
                </button>
            </nav>
        </div>

        <!-- Tab Content -->
        <div id="overview" class="tab-content active">
            <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-4 gap-6">
                <!-- Project Info Card -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-lg font-semibold mb-4">Current Project</h2>
                    <div id="projectInfo" class="space-y-2 text-sm">
                        <p class="text-gray-500">Select a project to view details</p>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-lg font-semibold mb-4">Issues</h2>
                    <div id="issueStats" class="space-y-2">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Total:</span>
                            <span class="font-bold">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Backlog:</span>
                            <span>0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">In Sprints:</span>
                            <span>0</span>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-lg font-semibold mb-4">Sprints</h2>
                    <div id="sprintStats" class="space-y-2">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Active:</span>
                            <span class="font-bold">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Planned:</span>
                            <span>0</span>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-lg font-semibold mb-4">Worktrees</h2>
                    <div id="worktreeStats" class="space-y-2">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Active:</span>
                            <span class="font-bold">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">With Sprints:</span>
                            <span>0</span>
                        </div>
                    </div>
                </div>

                <!-- Active Sessions (full width) -->
                <div class="bg-white rounded-lg shadow p-6 lg:col-span-2 xl:col-span-4">
                    <h2 class="text-lg font-semibold mb-4">Active Sessions</h2>
                    <div id="activeSessions" class="space-y-3">
                        <p class="text-gray-500 text-sm">Loading sessions...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ideas & Issues Tab -->
        <div id="ideas" class="tab-content">
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-semibold">
                        <svg class="inline-block w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                        </svg>
                        Issues & Ideas Registry
                    </h2>
                    <button onclick="showCreateIdea()" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 text-sm">
                        + New Issue/Idea
                    </button>
                </div>
                <div id="ideasList" class="space-y-3">
                    <p class="text-gray-500">Loading issues...</p>
                </div>
            </div>
        </div>

        <!-- Sprints Tab -->
        <div id="sprints" class="tab-content">
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-semibold">Sprint Management</h2>
                    <button onclick="showCreateSprint()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 text-sm">
                        + New Sprint
                    </button>
                </div>
                <div id="sprintsList" class="space-y-4">
                    <p class="text-gray-500">Loading sprints...</p>
                </div>
            </div>
        </div>

        <!-- Worktrees Tab -->
        <div id="worktrees" class="tab-content">
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-semibold">
                        <svg class="inline-block w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                        </svg>
                        Worktree Management
                    </h2>
                    <div class="flex gap-2">
                        <button onclick="checkPortStatuses()" class="px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded text-sm" title="Refresh port status">
                            <svg class="inline-block w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                            Check Ports
                        </button>
                        <button onclick="showCreateWorktree()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 text-sm">
                            + New Worktree
                        </button>
                    </div>
                </div>
                <div id="worktreesList" class="space-y-4">
                    <p class="text-gray-500">Loading worktrees...</p>
                </div>
            </div>
        </div>

        <!-- Sessions Tab -->
        <div id="sessions" class="tab-content">
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-semibold">Session Management</h2>
                    <button onclick="showCreateSession()" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 text-sm">
                        + New Session
                    </button>
                </div>
                <div id="sessionsList" class="space-y-3">
                    <p class="text-gray-500">Loading sessions...</p>
                </div>
            </div>
        </div>
        
        <!-- Branches Tab -->
        <div id="branches" class="tab-content">
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-semibold">Git Branches</h2>
                    <button onclick="refreshBranches()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 text-sm">
                        Refresh
                    </button>
                </div>
                <div id="branchesList" class="space-y-3">
                    <p class="text-gray-500">Click refresh to load branches...</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Modals -->
    <div id="modalOverlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div id="modalContent" class="bg-white rounded-lg p-6 max-w-md w-full mx-4 max-h-[80vh] overflow-y-auto">
            <!-- Modal content will be inserted here -->
        </div>
    </div>

    <script>
        // Make these global so they can be accessed by other scripts
        window.projects = {};
        window.activeProject = null;
        window.sessions = [];
        window.ideas = {};
        window.worktrees = [];
        window.sprintAssignments = {};
        window.branches = [];
        let currentTab = 'overview'; // Track which sprints are assigned to which worktrees

        // Helper function to get relative time
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            const intervals = {
                year: 31536000,
                month: 2592000,
                week: 604800,
                day: 86400,
                hour: 3600,
                minute: 60
            };
            
            for (const [unit, secondsInUnit] of Object.entries(intervals)) {
                const interval = Math.floor(seconds / secondsInUnit);
                if (interval >= 1) {
                    return `${interval} ${unit}${interval === 1 ? '' : 's'} ago`;
                }
            }
            return 'just now';
        }

        // Initialize - wait for deferred scripts to load
        // Expose functions to window for use by other scripts
        window.loadProjectData = loadProjectData;
        
        window.addEventListener('load', () => {
            loadData();
        });

        async function loadData() {
            try {
                // Load projects
                const projectsRes = await fetch('/api/projects');
                const projectsData = await projectsRes.json();
                window.projects = projectsData.projects;
                window.activeProject = projectsData.activeProject;
                
                // Update project selector
                const selector = document.getElementById('projectSelector');
                selector.innerHTML = Object.entries(projects).map(([id, project]) => 
                    `<option value="${id}" ${id === activeProject ? 'selected' : ''}>
                        ${project.name}
                    </option>`
                ).join('') + '<option value="__new__">+ Add New Project...</option>';
                
                // Load sessions
                const sessionsRes = await fetch('/api/sessions');
                window.sessions = await sessionsRes.json();
                
                // Update session count
                const activeCount = window.sessions.filter(s => s.status === 'ready' || s.status === 'active').length;
                document.getElementById('sessionCount').textContent = `${activeCount} active sessions`;
                
                // Load current project data
                if (window.activeProject) {
                    await loadProjectData(window.activeProject);
                }
                
                // Update all views
                updateOverview();
                updateIssues();
                updateSprints();
                updateWorktrees();
                updateSessions();
                
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        async function loadProjectData(projectId) {
            if (!projectId) return;
            
            try {
                // Load ideas/sprints
                const ideasRes = await fetch(`/api/projects/${projectId}/ideas`);
                window.ideas = await ideasRes.json();
                
                // Load worktrees with server status
                const worktreesRes = await fetch(`/api/projects/${projectId}/worktrees`);
                window.worktrees = await worktreesRes.json();
                console.log('Loaded worktrees:', worktrees);
                
                // Load sprint assignments from localStorage (or could be from server)
                const stored = localStorage.getItem(`sprint-assignments-${projectId}`);
                window.sprintAssignments = stored ? JSON.parse(stored) : {};
                
            } catch (error) {
                console.error('Error loading project data:', error);
            }
        }

        function updateOverview() {
            const project = window.projects[window.activeProject];
            if (!project) return;
            
            // Update project info
            // Define minimalistic SVG icons based on project icon type
            const iconSvg = {
                'MAIL': '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>',
                'STAR': '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path></svg>',
                'CODE': '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path></svg>',
                'DEFAULT': '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path></svg>'
            }[project.icon] || iconSvg.DEFAULT;
            
            document.getElementById('projectInfo').innerHTML = `
                <div class="space-y-3">
                    <div class="flex items-center space-x-2">
                        <span class="text-gray-500">${iconSvg}</span>
                        <div>
                            <p class="font-semibold">${project.name}</p>
                            <p class="text-gray-600 text-xs">${project.description}</p>
                        </div>
                    </div>
                </div>
            `;
            
            // Update stats
            const allItems = window.ideas.items || [];
            const backlogItems = allItems.filter(i => !i.sprint || i.sprint === 'backlog');
            const sprints = Object.keys(ideas.sprints || {});
            const activeSprints = sprints.filter(s => ideas.sprints[s].status === 'active');
            
            document.getElementById('issueStats').innerHTML = `
                <div class="flex justify-between">
                    <span class="text-gray-600">Total:</span>
                    <span class="font-bold">${allItems.length}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Backlog:</span>
                    <span>${backlogItems.length}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">In Sprints:</span>
                    <span>${allItems.length - backlogItems.length}</span>
                </div>
            `;
            
            document.getElementById('sprintStats').innerHTML = `
                <div class="flex justify-between">
                    <span class="text-gray-600">Total:</span>
                    <span class="font-bold">${sprints.length}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Active:</span>
                    <span>${activeSprints.length}</span>
                </div>
            `;
            
            const worktreesWithSprints = worktrees.filter(w => 
                Object.values(sprintAssignments).some(a => a.worktree === w.name)
            );
            
            document.getElementById('worktreeStats').innerHTML = `
                <div class="flex justify-between">
                    <span class="text-gray-600">Total:</span>
                    <span class="font-bold">${worktrees.length}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">With Sprints:</span>
                    <span>${worktreesWithSprints.length}</span>
                </div>
            `;
            
            // Update active sessions
            const activeSessions = window.sessions.filter(s => 
                s.projectId === window.activeProject && (s.status === 'ready' || s.status === 'active')
            );
            
            document.getElementById('activeSessions').innerHTML = activeSessions.length > 0 
                ? activeSessions.map(session => `
                    <div class="border rounded-lg p-4 hover:bg-gray-50">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-medium">${session.sprint}</p>
                                <p class="text-sm text-gray-600 mt-1">
                                    Worktree: ${session.worktree} • ${session.items} items
                                </p>
                            </div>
                            <button onclick="viewSessionPrompt('${session.sessionId}')" 
                                class="px-2 py-1 text-xs bg-blue-500 text-white rounded hover:bg-blue-600">
                                View Prompt
                            </button>
                        </div>
                    </div>
                `).join('')
                : '<p class="text-gray-500 text-sm">No active sessions</p>';
        }

        function updateIssues() {
            // Use the improved renderIdeasTab function if available
            if (typeof renderIdeasTab === 'function') {
                renderIdeasTab();
                return;
            }
            
            // Fallback rendering (shouldn't normally be reached)
            const allItems = window.ideas.items || [];
            document.getElementById('ideasList').innerHTML = allItems.length > 0 
                ? allItems.map(item => `
                    <div class="border rounded-lg p-3">
                        <p class="font-medium text-sm">${item.title}</p>
                        <p class="text-xs text-gray-600">${item.type} - ${item.priority} - ${item.status || 'new'}</p>
                    </div>
                `).join('')
                : '<p class="text-gray-500">No issues or ideas yet</p>';
        }

        function updateSprints() {
            // Use the improved renderSprintsTab function if available
            if (typeof renderSprintsTab === 'function') {
                renderSprintsTab();
                return;
            }
            
            // Fallback
            if (!ideas.sprints) {
                document.getElementById('sprintsList').innerHTML = '<p class="text-gray-500">No sprints yet</p>';
                return;
            }
            
            document.getElementById('sprintsList').innerHTML = Object.entries(ideas.sprints).map(([name, sprint]) => {
                const items = window.ideas.items?.filter(i => i.sprint === name) || [];
                const todoItems = items.filter(i => i.status !== 'done');
                const assignment = sprintAssignments[name];
                
                return `
                    <div class="border rounded-lg p-4">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <p class="font-medium text-lg">${name}</p>
                                <p class="text-sm text-gray-600 mt-1">${sprint.description || 'No description'}</p>
                                <div class="flex gap-3 mt-2">
                                    <span class="text-xs text-gray-600">
                                        Todo: <span class="font-bold">${todoItems.length}</span>
                                    </span>
                                    <span class="text-xs text-gray-600">
                                        Total: <span class="font-bold">${items.length}</span>
                                    </span>
                                </div>
                                ${assignment ? `
                                    <div class="mt-2 p-2 bg-green-50 rounded">
                                        <span class="text-xs text-green-700">
                                            Assigned to worktree: <strong>${assignment.worktree}</strong>
                                        </span>
                                    </div>
                                ` : `
                                    <div class="mt-2 p-2 bg-yellow-50 rounded">
                                        <span class="text-xs text-yellow-700">
                                            Not assigned to any worktree
                                        </span>
                                    </div>
                                `}
                            </div>
                            <div class="flex flex-col gap-1">
                                <button onclick="assignSprintToWorktree('${name}')" 
                                    class="px-3 py-1 text-sm bg-blue-500 text-white rounded hover:bg-blue-600">
                                    ${assignment ? 'Reassign' : 'Assign'} Worktree
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateWorktrees() {
            // Use the improved renderWorktreesTab function if available
            if (typeof renderWorktreesTab === 'function') {
                renderWorktreesTab();
                return;
            }
            
            // Fallback
            document.getElementById('worktreesList').innerHTML = worktrees.length > 0
                ? worktrees.map(wt => {
                    // Find sprints assigned to this worktree
                    const assignedSprints = Object.entries(sprintAssignments)
                        .filter(([sprint, assignment]) => assignment.worktree === wt.name)
                        .map(([sprint]) => sprint);
                    
                    return `
                        <div class="border rounded-lg p-4">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <p class="font-medium text-lg">${wt.name}</p>
                                    <p class="text-sm text-gray-600">${wt.description || 'No description'}</p>
                                    <div class="mt-2 space-y-1 text-xs">
                                        <div>Frontend: localhost:${wt.frontendPort || '?'}</div>
                                        <div>Backend: localhost:${wt.backendPort || '?'}</div>
                                    </div>
                                    ${assignedSprints.length > 0 ? `
                                        <div class="mt-3 p-2 bg-blue-50 rounded">
                                            <p class="text-xs font-medium text-blue-700 mb-1">Assigned Sprints:</p>
                                            ${assignedSprints.map(s => `
                                                <span class="inline-block px-2 py-1 text-xs bg-white rounded mr-1 mb-1">
                                                    ${s}
                                                </span>
                                            `).join('')}
                                        </div>
                                    ` : `
                                        <div class="mt-3 p-2 bg-gray-50 rounded">
                                            <p class="text-xs text-gray-600">No sprints assigned</p>
                                        </div>
                                    `}
                                </div>
                                <div class="flex flex-col gap-1">
                                    ${assignedSprints.length > 0 ? `
                                        <button onclick="createSessionForWorktree('${wt.name}')" 
                                            class="px-3 py-1 text-sm bg-green-500 text-white rounded hover:bg-green-600">
                                            Create Session
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('')
                : '<p class="text-gray-500">No worktrees yet</p>';
        }

        function updateSessions() {
            // Use the improved renderSessionsTab function if available
            if (typeof renderSessionsTab === 'function') {
                renderSessionsTab();
                return;
            }
            
            // Fallback
            const projectSessions = window.sessions.filter(s => s.projectId === window.activeProject);
            
            document.getElementById('sessionsList').innerHTML = projectSessions.length > 0
                ? projectSessions.map(session => `
                    <div class="border rounded-lg p-4 hover:bg-gray-50">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-medium text-sm">${session.sessionId}</p>
                                <p class="text-sm text-gray-600 mt-1">
                                    Sprint: ${session.sprint} • Worktree: ${session.worktree}
                                </p>
                                <p class="text-xs text-gray-500 mt-1">
                                    ${session.items} items • ${new Date(session.created).toLocaleString()}
                                </p>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="px-2 py-1 text-xs ${
                                    session.status === 'completed' ? 'bg-green-100 text-green-800' :
                                    session.status === 'active' ? 'bg-blue-100 text-blue-800' :
                                    'bg-gray-100 text-gray-800'
                                } rounded">
                                    ${session.status}
                                </span>
                                <button onclick="viewSessionPrompt('${session.sessionId}')" 
                                    class="px-2 py-1 text-xs bg-blue-500 text-white rounded hover:bg-blue-600">
                                    Prompt
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('')
                : '<p class="text-gray-500 text-sm">No sessions yet</p>';
        }

        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('border-blue-500', 'text-blue-600');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            event.target.classList.remove('border-transparent', 'text-gray-500');
            event.target.classList.add('border-blue-500', 'text-blue-600');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');
            
            // Store current tab
            currentTab = tabName;
            
            // Update content based on tab
            if (tabName === 'ideas') {
                updateIssues();
            } else if (tabName === 'sprints') {
                updateSprints();
            } else if (tabName === 'worktrees') {
                updateWorktrees();
            } else if (tabName === 'sessions') {
                updateSessions();
            } else if (tabName === 'branches' && branches.length === 0) {
                refreshBranches();
            }
        }
        
        async function refreshBranches() {
            if (!window.activeProject) {
                document.getElementById('branchesList').innerHTML = '<p class="text-gray-500">Please select a project first</p>';
                return;
            }
            
            document.getElementById('branchesList').innerHTML = '<p class="text-gray-500">Loading branches...</p>';
            
            try {
                const res = await fetch(`/api/projects/${activeProject}/branches`);
                window.branches = await res.json();
                updateBranches();
            } catch (error) {
                document.getElementById('branchesList').innerHTML = 
                    `<p class="text-red-500">Failed to load branches: ${error.message}</p>`;
            }
        }
        
        function updateBranches() {
            if (!branches || branches.length === 0) {
                document.getElementById('branchesList').innerHTML = '<p class="text-gray-500">No branches found</p>';
                return;
            }
            
            document.getElementById('branchesList').innerHTML = branches.map(branch => {
                const statusColor = 
                    branch.status === 'stale' ? 'bg-orange-50 border-orange-300' :
                    branch.status === 'merged' ? 'bg-purple-50 border-purple-300' :
                    branch.status === 'active' ? 'bg-green-50 border-green-300' :
                    branch.status === 'wip' ? 'bg-blue-50 border-blue-300' :
                    'bg-gray-50 border-gray-300';
                
                const hasUncommitted = branch.uncommittedChanges > 0;
                const hasUnpushed = branch.unpushedCommits > 0;
                
                return `
                    <div class="border rounded-lg p-4 ${statusColor}">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <p class="font-medium ${branch.current ? 'text-blue-600' : ''}">
                                        ${branch.current ? '► ' : ''}${branch.name}
                                    </p>
                                    ${branch.isStale ? 
                                        `<span class="px-2 py-0.5 bg-orange-100 text-orange-700 rounded text-xs font-medium" title="${branch.commitsBehind} commits behind main">
                                            ⚠️ Stale (${branch.commitsBehind} behind)
                                        </span>` :
                                        branch.isMerged ? 
                                        '<span class="px-2 py-0.5 bg-purple-100 text-purple-700 rounded text-xs font-medium">Merged</span>' :
                                        hasUncommitted ? 
                                        `<span class="px-2 py-0.5 bg-yellow-100 text-yellow-700 rounded text-xs font-medium">
                                            ${branch.uncommittedChanges} uncommitted
                                        </span>` : 
                                        hasUnpushed ?
                                        `<span class="px-2 py-0.5 bg-blue-100 text-blue-700 rounded text-xs font-medium">
                                            ${branch.unpushedCommits} unpushed
                                        </span>` :
                                        '<span class="px-2 py-0.5 bg-green-100 text-green-700 rounded text-xs">Clean</span>'
                                    }
                                    ${branch.current ? 
                                        '<span class="px-2 py-0.5 bg-blue-100 text-blue-700 rounded text-xs">Current</span>' : ''
                                    }
                                </div>
                                <p class="text-sm text-gray-600">
                                    <span class="font-mono text-xs">${branch.lastCommitHash}</span> - 
                                    ${branch.lastCommitMessage || 'No commits'}
                                </p>
                                <div class="flex gap-3 mt-2 text-xs text-gray-500">
                                    ${branch.lastCommitDate ? `
                                        <span>
                                            Last: ${new Date(branch.lastCommitDate).toLocaleDateString()} 
                                            (${getTimeAgo(new Date(branch.lastCommitDate))})
                                        </span>
                                    ` : ''}
                                    ${branch.tracking ? `
                                        <span>Tracking: <span class="font-mono">${branch.tracking}</span></span>
                                    ` : '<span class="text-gray-400">Local only</span>'}
                                    ${branch.behindBy > 0 ? `
                                        <span class="text-red-600 font-medium">
                                            ${branch.behindBy} behind
                                        </span>
                                    ` : ''}
                                </div>
                                ${branch.relatedSprint ? `
                                    <div class="mt-2 text-xs">
                                        <span class="text-gray-600">Sprint: </span>
                                        <span class="font-medium">${branch.relatedSprint}</span>
                                    </div>
                                ` : ''}
                                ${branch.relatedWorktree ? `
                                    <div class="text-xs">
                                        <span class="text-gray-600">Worktree: </span>
                                        <span class="font-medium">${branch.relatedWorktree}</span>
                                    </div>
                                ` : ''}
                            </div>
                            <div class="flex flex-col gap-1">
                                ${branch.current ? '' : `
                                    <button onclick="checkoutBranch('${branch.name}')" 
                                        class="px-2 py-1 text-xs bg-blue-500 text-white rounded hover:bg-blue-600">
                                        Checkout
                                    </button>
                                `}
                                ${branch.isStale && !branch.current ? `
                                    <div class="flex flex-col gap-1">
                                        <button onclick="updateStaleBranch('${branch.name}', 'merge')" 
                                            class="px-2 py-1 text-xs bg-blue-500 text-white rounded hover:bg-blue-600" 
                                            title="Merge: Creates a merge commit. Preserves branch history. Safer but adds merge commits to history.">
                                            Merge Main
                                        </button>
                                        <button onclick="updateStaleBranch('${branch.name}', 'rebase')" 
                                            class="px-2 py-1 text-xs bg-green-500 text-white rounded hover:bg-green-600" 
                                            title="Rebase: Replays your commits on top of main. Creates linear history. Cleaner but rewrites commit history.">
                                            Rebase Main
                                        </button>
                                        <button onclick="deleteMergedBranch('${branch.name}')" 
                                            class="px-2 py-1 text-xs bg-red-500 text-white rounded hover:bg-red-600"
                                            title="Delete this stale branch">
                                            Delete
                                        </button>
                                    </div>
                                ` : branch.isMerged && !branch.current && branch.name !== 'main' ? `
                                    <button onclick="deleteMergedBranch('${branch.name}')" 
                                        class="px-2 py-1 text-xs bg-purple-500 text-white rounded hover:bg-purple-600">
                                        Delete
                                    </button>
                                ` : ''}
                                ${hasUncommitted || hasUnpushed ? `
                                    <button onclick="showBranchActions('${branch.name}')" 
                                        class="px-2 py-1 text-xs bg-orange-500 text-white rounded hover:bg-orange-600">
                                        Actions
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        async function checkoutBranch(branchName) {
            alert(`Checkout ${branchName} - This would run: git checkout ${branchName}`);
            // In a real implementation, this would call an API to checkout the branch
        }
        
        function showBranchActions(branchName) {
            const branch = branches.find(b => b.name === branchName);
            if (!branch) return;
            
            let actions = [];
            if (branch.uncommittedChanges > 0) {
                actions.push('• Commit changes: git add -A && git commit -m "message"');
            }
            if (branch.unpushedCommits > 0) {
                actions.push('• Push commits: git push origin ' + branchName);
            }
            if (branch.behindBy > 0) {
                actions.push('• Pull changes: git pull origin ' + branchName);
            }
            
            alert('Recommended actions for ' + branchName + ':\\n\\n' + actions.join('\\n'));
        }
        
        async function deleteMergedBranch(branchName) {
            if (confirm(`Delete merged branch '${branchName}'?\n\nThis will run: git branch -d ${branchName}`)) {
                try {
                    // Encode branch name to handle slashes
                    const encodedBranch = encodeURIComponent(branchName);
                    const res = await fetch(`/api/projects/${activeProject}/branches/${encodedBranch}`, {
                        method: 'DELETE'
                    });
                    
                    // Check if response is JSON
                    const contentType = res.headers.get("content-type");
                    if (contentType && contentType.indexOf("application/json") !== -1) {
                        const data = await res.json();
                        if (res.ok) {
                            alert(`Branch '${branchName}' deleted successfully`);
                            refreshBranches();
                        } else {
                            alert(`Failed to delete branch: ${data.error || data.message || 'Unknown error'}`);
                        }
                    } else {
                        // Response is not JSON (probably HTML error page)
                        const text = await res.text();
                        console.error('Delete branch error response:', text);
                        alert(`Error: Server returned an unexpected response. Check console for details.`);
                    }
                } catch (error) {
                    alert(`Error deleting branch: ${error.message}`);
                }
            }
        }
        
        async function updateStaleBranch(branchName, method) {
            const branch = branches.find(b => b.name === branchName);
            if (!branch) return;
            
            const explanation = method === 'merge' 
                ? `This will merge main into '${branchName}':\n\n` +
                  `• Creates a merge commit\n` +
                  `• Preserves your branch's commit history\n` +
                  `• Safer - won't rewrite history\n` +
                  `• May create a messier git history\n\n` +
                  `The branch is ${branch.commitsBehind} commits behind main.`
                : `This will rebase '${branchName}' onto main:\n\n` +
                  `• Replays your commits on top of main\n` +
                  `• Creates a linear, cleaner history\n` +
                  `• Rewrites commit history (changes commit hashes)\n` +
                  `• May need force push if already pushed\n\n` +
                  `The branch is ${branch.commitsBehind} commits behind main.`;
            
            if (confirm(explanation + '\n\nProceed?')) {
                try {
                    // Encode the branch name to handle slashes in branch names like feature/something
                    const encodedBranch = encodeURIComponent(branchName);
                    const res = await fetch(`/api/projects/${activeProject}/branches/${encodedBranch}/update`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ method })
                    });
                    
                    // Check if response is JSON
                    const contentType = res.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        const text = await res.text();
                        console.error('Server returned non-JSON response:', text);
                        alert(`❌ Server error: Expected JSON but got HTML. The server may be down or the endpoint may not exist.\n\nCheck the console for details.`);
                        return;
                    }
                    
                    if (res.ok) {
                        const result = await res.json();
                        alert(`✅ Success!\n\nBranch '${branchName}' has been updated with main using ${method}.\n\n${result.message}`);
                        refreshBranches();
                    } else {
                        const error = await res.json();
                        alert(`❌ Failed to ${method} branch:\n\n${error.error}\n\n${error.hint || 'You may need to resolve this manually.'}`);
                    }
                } catch (error) {
                    console.error('Error updating branch:', error);
                    alert(`Error updating branch: ${error.message}`);
                }
            }
        }

        // Project selector change
        document.getElementById('projectSelector').addEventListener('change', async (e) => {
            const projectId = e.target.value;
            
            if (projectId === '__new__') {
                // Show new project modal
                showCreateProjectModal();
                // Reset selector to current project
                e.target.value = window.activeProject || '';
                return;
            }
            
            if (projectId && projectId !== window.activeProject) {
                await fetch('/api/projects/select', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ projectId })
                });
                window.activeProject = projectId;
                await loadData();
            }
        });

        // Removed changeItemStatus - now handled by inline editing
        
        // Removed editItem - now handled by clicking on the card
        
        function editItemOld(itemId) {
            const item = window.ideas.items.find(i => i.id === itemId);
            if (!item) return;
            
            showModal(`
                <h3 class="text-lg font-semibold mb-4">Edit ${item.type}: ${item.id}</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Title</label>
                        <input type="text" id="editTitle" value="${item.title}" 
                            class="w-full px-3 py-2 border rounded" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Description</label>
                        <textarea id="editDescription" rows="4" 
                            class="w-full px-3 py-2 border rounded">${item.description || ''}</textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Priority</label>
                        <select id="editPriority" class="w-full px-3 py-2 border rounded">
                            <option value="low" ${item.priority === 'low' ? 'selected' : ''}>Low</option>
                            <option value="medium" ${item.priority === 'medium' ? 'selected' : ''}>Medium</option>
                            <option value="high" ${item.priority === 'high' ? 'selected' : ''}>High</option>
                            <option value="critical" ${item.priority === 'critical' ? 'selected' : ''}>Critical</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Effort</label>
                        <input type="text" id="editEffort" value="${item.effort || ''}" 
                            placeholder="e.g., 2h, 1d, 1w" 
                            class="w-full px-3 py-2 border rounded" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Tags (comma-separated)</label>
                        <input type="text" id="editTags" value="${(item.tags || []).join(', ')}" 
                            class="w-full px-3 py-2 border rounded" />
                    </div>
                    <div class="flex justify-end space-x-2">
                        <button onclick="hideModal()" class="px-4 py-2 border rounded hover:bg-gray-50">
                            Cancel
                        </button>
                        <button onclick="saveItemEdit('${itemId}')" 
                            class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                            Save Changes
                        </button>
                    </div>
                </div>
            `);
        }

        function saveItemEdit(itemId) {
            const item = window.ideas.items.find(i => i.id === itemId);
            if (!item) return;
            
            item.title = document.getElementById('editTitle').value;
            item.description = document.getElementById('editDescription').value;
            item.priority = document.getElementById('editPriority').value;
            item.effort = document.getElementById('editEffort').value;
            item.tags = document.getElementById('editTags').value.split(',').map(t => t.trim()).filter(t => t);
            item.updated = new Date().toISOString();
            
            fetch(`/api/projects/${activeProject}/ideas`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(ideas)
            }).then(() => {
                hideModal();
                updateIdeas();
            });
        }

        // Modal functions
        function showModal(content) {
            document.getElementById('modalContent').innerHTML = content;
            document.getElementById('modalOverlay').classList.remove('hidden');
        }

        function hideModal() {
            document.getElementById('modalOverlay').classList.add('hidden');
        }

        function assignSprintToWorktree(sprintName) {
            const currentAssignment = sprintAssignments[sprintName];
            
            showModal(`
                <h3 class="text-lg font-semibold mb-4">Assign Sprint to Worktree</h3>
                <p class="text-sm text-gray-600 mb-4">Sprint: <strong>${sprintName}</strong></p>
                <div class="space-y-4">
                    ${worktrees.length > 0 ? `
                        <div>
                            <label class="block text-sm font-medium mb-1">Select Existing Worktree</label>
                            <select id="worktreeSelect" class="w-full px-3 py-2 border rounded">
                                <option value="">-- Select Worktree --</option>
                                ${worktrees.map(wt => `
                                    <option value="${wt.name}" ${currentAssignment?.worktree === wt.name ? 'selected' : ''}>
                                        ${wt.name} (Frontend: ${wt.frontendPort}, Backend: ${wt.backendPort})
                                    </option>
                                `).join('')}
                                <option value="__new__">➕ Create New Worktree...</option>
                            </select>
                        </div>
                    ` : `
                        <div class="p-3 bg-yellow-50 border border-yellow-200 rounded">
                            <p class="text-sm text-yellow-800">No worktrees exist yet.</p>
                            <p class="text-sm text-yellow-800 mt-1">Click "Create New Worktree" to get started.</p>
                        </div>
                    `}
                    
                    <div id="newWorktreeForm" class="hidden space-y-3 p-3 bg-gray-50 rounded">
                        <h4 class="text-sm font-semibold">Create New Worktree</h4>
                        <div>
                            <label class="block text-xs font-medium mb-1">Worktree Name</label>
                            <input type="text" id="newWorktreeName" 
                                placeholder="feature-${sprintName.toLowerCase().replace(/\s+/g, '-')}"
                                class="w-full px-2 py-1 text-sm border rounded">
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-xs font-medium mb-1">Frontend Port</label>
                                <input type="number" id="newFrontendPort" placeholder="5174" 
                                    class="w-full px-2 py-1 text-sm border rounded">
                            </div>
                            <div>
                                <label class="block text-xs font-medium mb-1">Backend Port</label>
                                <input type="number" id="newBackendPort" placeholder="3002" 
                                    class="w-full px-2 py-1 text-sm border rounded">
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-between">
                        ${worktrees.length === 0 ? `
                            <button onclick="document.getElementById('newWorktreeForm').classList.remove('hidden'); this.style.display='none';" 
                                class="px-3 py-1 text-sm bg-green-500 text-white rounded hover:bg-green-600">
                                ➕ Create New Worktree
                            </button>
                        ` : '<div></div>'}
                        <div class="flex gap-2">
                            <button onclick="hideModal()" class="px-3 py-1 text-sm border rounded hover:bg-gray-50">
                                Cancel
                            </button>
                            <button onclick="saveSprintAssignmentWithWorktree('${sprintName}')" 
                                class="px-3 py-1 text-sm bg-blue-500 text-white rounded hover:bg-blue-600">
                                Assign
                            </button>
                        </div>
                    </div>
                </div>
            `);
            
            // Add change handler for worktree select
            setTimeout(() => {
                const select = document.getElementById('worktreeSelect');
                if (select) {
                    select.addEventListener('change', (e) => {
                        const form = document.getElementById('newWorktreeForm');
                        if (e.target.value === '__new__') {
                            form.classList.remove('hidden');
                            // Suggest a name based on sprint
                            document.getElementById('newWorktreeName').value = 
                                'feature-' + sprintName.toLowerCase().replace(/\s+/g, '-');
                        } else {
                            form.classList.add('hidden');
                        }
                    });
                }
            }, 100);
        }

        async function saveSprintAssignmentWithWorktree(sprintName) {
            const worktreeSelect = document.getElementById('worktreeSelect');
            let worktreeName = worktreeSelect ? worktreeSelect.value : null;
            
            // Check if creating new worktree
            if (worktreeName === '__new__' || !worktreeSelect) {
                const nameInput = document.getElementById('newWorktreeName');
                const frontendPort = document.getElementById('newFrontendPort').value || 5174;
                const backendPort = document.getElementById('newBackendPort').value || 3002;
                
                worktreeName = nameInput.value || 'feature-' + sprintName.toLowerCase().replace(/\s+/g, '-');
                
                // Create the worktree first
                try {
                    const response = await fetch(`/api/projects/${activeProject}/worktrees`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            branchName: worktreeName,
                            description: `Worktree for ${sprintName} sprint`,
                            frontendPort: parseInt(frontendPort),
                            backendPort: parseInt(backendPort)
                        })
                    });
                    
                    if (!response.ok) throw new Error('Failed to create worktree');
                    
                    // Reload worktrees
                    await loadProjectData(window.activeProject);
                } catch (error) {
                    alert('Failed to create worktree: ' + error.message);
                    return;
                }
            }
            
            if (!worktreeName) {
                alert('Please select or create a worktree');
                return;
            }
            
            // Save the assignment
            sprintAssignments[sprintName] = {
                worktree: worktreeName,
                assignedAt: new Date().toISOString()
            };
            
            localStorage.setItem(`sprint-assignments-${activeProject}`, JSON.stringify(sprintAssignments));
            
            hideModal();
            updateSprints();
            updateWorktrees();
        }
        
        function saveSprintAssignment(sprintName) {
            const worktreeName = document.getElementById('worktreeSelect').value;
            if (!worktreeName) {
                alert('Please select a worktree');
                return;
            }
            
            sprintAssignments[sprintName] = {
                worktree: worktreeName,
                assignedAt: new Date().toISOString()
            };
            
            // Save to localStorage
            localStorage.setItem(`sprint-assignments-${activeProject}`, JSON.stringify(sprintAssignments));
            
            hideModal();
            updateSprints();
            updateWorktrees();
            alert(`Sprint "${sprintName}" assigned to worktree "${worktreeName}"`);
        }

        function createSessionForWorktree(worktreeName) {
            // Find sprints assigned to this worktree
            const assignedSprints = Object.entries(sprintAssignments)
                .filter(([sprint, assignment]) => assignment.worktree === worktreeName)
                .map(([sprint]) => sprint);
            
            if (assignedSprints.length === 0) {
                alert('No sprints assigned to this worktree');
                return;
            }
            
            let selectedSprint = assignedSprints[0];
            if (assignedSprints.length > 1) {
                selectedSprint = prompt(`Select sprint for session:\n\n${assignedSprints.join('\n')}`);
                if (!selectedSprint || !assignedSprints.includes(selectedSprint)) {
                    return;
                }
            }
            
            createSession(selectedSprint, worktreeName);
        }

        async function createSession(sprintName, worktreeName) {
            if (!sprintName || !worktreeName) {
                alert('Sprint and worktree are required');
                return;
            }
            
            try {
                const res = await fetch('/api/sessions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        projectId: activeProject,
                        sprintName: sprintName,
                        worktreeName: worktreeName
                    })
                });
                
                const data = await res.json();
                if (data.success) {
                    await loadData();
                    alert(`Session created! ID: ${data.session.sessionId}`);
                    
                    if (confirm('View session prompt?')) {
                        viewSessionPrompt(data.session.sessionId);
                    }
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Failed to create session: ' + error.message);
            }
        }

        function showCreateSession() {
            // Get sprints with worktree assignments
            const assignedSprints = Object.entries(sprintAssignments)
                .map(([sprint, assignment]) => ({ sprint, worktree: assignment.worktree }));
            
            if (assignedSprints.length === 0) {
                alert('Please assign a sprint to a worktree first');
                return;
            }
            
            showModal(`
                <h3 class="text-lg font-semibold mb-4">Create New Session</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Select Sprint & Worktree</label>
                        <select id="sessionConfig" class="w-full px-3 py-2 border rounded">
                            ${assignedSprints.map(config => `
                                <option value="${config.sprint}|${config.worktree}">
                                    ${config.sprint} → ${config.worktree}
                                </option>
                            `).join('')}
                        </select>
                    </div>
                    <div class="flex justify-end space-x-2">
                        <button onclick="hideModal()" class="px-4 py-2 border rounded hover:bg-gray-50">
                            Cancel
                        </button>
                        <button onclick="createSessionFromModal()" 
                            class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
                            Create Session
                        </button>
                    </div>
                </div>
            `);
        }

        function createSessionFromModal() {
            const config = document.getElementById('sessionConfig').value;
            const [sprint, worktree] = config.split('|');
            hideModal();
            createSession(sprint, worktree);
        }

        function showCreateIdea() {
            if (!window.activeProject) {
                alert('Please select a project first');
                return;
            }
            
            showModal(`
                <h3 class="text-lg font-semibold mb-4">Create New Issue/Idea</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Type</label>
                        <select id="itemType" class="w-full px-3 py-2 border rounded">
                            <option value="bug">Bug</option>
                            <option value="feature">Feature</option>
                            <option value="task">Task</option>
                            <option value="idea">Idea</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Title</label>
                        <input id="itemTitle" type="text" class="w-full px-3 py-2 border rounded" 
                            placeholder="Brief description">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Description</label>
                        <textarea id="itemDesc" class="w-full px-3 py-2 border rounded" rows="3"
                            placeholder="Detailed description"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Priority</label>
                        <select id="itemPriority" class="w-full px-3 py-2 border rounded">
                            <option value="low">Low</option>
                            <option value="medium" selected>Medium</option>
                            <option value="high">High</option>
                            <option value="critical">Critical</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Sprint</label>
                        <select id="itemSprint" class="w-full px-3 py-2 border rounded">
                            <option value="backlog">Backlog</option>
                            ${Object.keys(ideas.sprints || {}).map(s => 
                                `<option value="${s}">${s}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div class="flex justify-end space-x-2">
                        <button onclick="hideModal()" class="px-4 py-2 border rounded hover:bg-gray-50">
                            Cancel
                        </button>
                        <button onclick="createIdea()" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
                            Create Issue
                        </button>
                    </div>
                </div>
            `);
        }

        async function createIdea() {
            const type = document.getElementById('itemType').value;
            const title = document.getElementById('itemTitle').value;
            const desc = document.getElementById('itemDesc').value;
            const priority = document.getElementById('itemPriority').value;
            const sprint = document.getElementById('itemSprint').value;
            
            if (!title) {
                alert('Please enter a title');
                return;
            }
            
            if (!window.ideas.items) window.ideas.items = [];
            
            // Generate ID
            const typePrefix = type === 'bug' ? 'bug' : type === 'feature' ? 'feature' : type === 'task' ? 'task' : 'idea';
            const nextNum = window.ideas.items.filter(i => i.id?.startsWith(typePrefix)).length + 1;
            const id = `${typePrefix}-${String(nextNum).padStart(3, '0')}`;
            
            const newItem = {
                id,
                type,
                title,
                description: desc,
                priority,
                sprint,
                status: 'new',
                created: new Date().toISOString(),
                updated: new Date().toISOString()
            };
            
            window.ideas.items.push(newItem);
            
            try {
                await fetch(`/api/projects/${window.activeProject}/ideas`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(window.ideas)
                });
                
                hideModal();
                updateIssues();
                updateSprints();
                updateOverview();
                alert(`Created ${type}: ${id}`);
            } catch (error) {
                alert('Failed to create item: ' + error.message);
            }
        }

        function showCreateSprint() {
            if (!window.activeProject) {
                alert('Please select a project first');
                return;
            }
            
            const today = new Date().toISOString().split('T')[0];
            const twoWeeksLater = new Date(Date.now() + 14 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            
            showModal(`
                <h3 class="text-lg font-semibold mb-4">Create New Sprint</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Sprint Name *</label>
                        <input id="sprintName" type="text" class="w-full px-3 py-2 border rounded" 
                            placeholder="Sprint 2025-01" autofocus>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Description</label>
                        <textarea id="sprintDesc" rows="2" class="w-full px-3 py-2 border rounded" 
                            placeholder="Sprint goals and focus areas..."></textarea>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Start Date</label>
                            <input id="sprintStart" type="date" value="${today}" 
                                class="w-full px-3 py-2 border rounded" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">End Date</label>
                            <input id="sprintEnd" type="date" value="${twoWeeksLater}" 
                                class="w-full px-3 py-2 border rounded" />
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Goals (one per line)</label>
                        <textarea id="sprintGoals" rows="3" class="w-full px-3 py-2 border rounded" 
                            placeholder="Fix critical bugs
Implement user authentication
Improve performance"></textarea>
                    </div>
                    <div class="flex justify-end space-x-2">
                        <button onclick="hideModal()" class="px-4 py-2 border rounded hover:bg-gray-50">
                            Cancel
                        </button>
                        <button onclick="createSprint()" class="px-4 py-2 bg-purple-500 text-white rounded hover:bg-purple-600">
                            Create Sprint
                        </button>
                    </div>
                </div>
            `);
        }

        async function createSprint() {
            const name = document.getElementById('sprintName').value;
            const desc = document.getElementById('sprintDesc').value || '';
            const start = document.getElementById('sprintStart').value || new Date().toISOString().split('T')[0];
            const end = document.getElementById('sprintEnd').value || '';
            const goalsText = document.getElementById('sprintGoals').value || '';
            const goals = goalsText.split('\n').map(g => g.trim()).filter(g => g);
            
            if (!name) {
                alert('Please enter a sprint name');
                return;
            }
            
            if (!window.ideas.sprints) window.ideas.sprints = {};
            
            if (window.ideas.sprints[name]) {
                alert('A sprint with this name already exists');
                return;
            }
            
            window.ideas.sprints[name] = {
                name: name,
                description: desc,
                start: start,
                end: end,
                goals: goals,
                status: 'active',
                created: new Date().toISOString()
            };
            
            try {
                await fetch(`/api/projects/${window.activeProject}/ideas`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(window.ideas)
                });
                
                hideModal();
                updateSprints();
                updateOverview();
                updateIdeas(); // Update the ideas dropdown to show new sprint
                alert('Sprint created!');
            } catch (error) {
                alert('Failed to create sprint: ' + error.message);
            }
        }

        function showCreateProjectModal() {
            showModal(`
                <h3 class="text-lg font-semibold mb-4">Create New Project</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Project Name *</label>
                        <input id="newProjectName" type="text" class="w-full px-3 py-2 border rounded" 
                            placeholder="my-awesome-project" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Display Name *</label>
                        <input id="newProjectDisplayName" type="text" class="w-full px-3 py-2 border rounded" 
                            placeholder="My Awesome Project" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Description</label>
                        <textarea id="newProjectDescription" rows="2" class="w-full px-3 py-2 border rounded" 
                            placeholder="Brief description of your project"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Icon Label</label>
                        <input id="newProjectIcon" type="text" class="w-full px-3 py-2 border rounded" 
                            placeholder="CODE" maxlength="4">
                        <p class="text-xs text-gray-500 mt-1">4 characters max (e.g., CODE, APP, WEB)</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Project Location</label>
                        <select id="newProjectLocation" class="w-full px-3 py-2 border rounded">
                            <option value="new">Create new directory in /Users/kellypellas/DevProjects/</option>
                            <option value="existing">Use existing directory</option>
                        </select>
                    </div>
                    <div id="existingPathInput" class="hidden">
                        <label class="block text-sm font-medium mb-1">Existing Directory Path</label>
                        <input id="newProjectPath" type="text" class="w-full px-3 py-2 border rounded" 
                            placeholder="/Users/kellypellas/DevProjects/my-project">
                    </div>
                    <div class="border-t pt-4">
                        <label class="flex items-center">
                            <input id="newProjectGitInit" type="checkbox" checked class="mr-2">
                            <span class="text-sm">Initialize Git repository</span>
                        </label>
                    </div>
                    <div id="githubOptions" class="space-y-3 p-3 bg-gray-50 rounded">
                        <label class="flex items-center">
                            <input id="newProjectGithub" type="checkbox" checked class="mr-2">
                            <span class="text-sm">Create GitHub repository</span>
                        </label>
                        <div id="githubSettings" class="space-y-3">
                            <div>
                                <label class="block text-xs font-medium mb-1">GitHub Repository Name</label>
                                <input id="newProjectGithubRepo" type="text" class="w-full px-2 py-1 text-sm border rounded" 
                                    placeholder="my-awesome-project">
                            </div>
                            <div>
                                <label class="block text-xs font-medium mb-1">Repository Visibility</label>
                                <select id="newProjectGithubVisibility" class="w-full px-2 py-1 text-sm border rounded">
                                    <option value="private">Private</option>
                                    <option value="public">Public</option>
                                </select>
                            </div>
                            <p class="text-xs text-gray-600">Will create repository under: github.com/kpellas/</p>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-2">
                        <button onclick="hideModal()" class="px-4 py-2 border rounded hover:bg-gray-50">
                            Cancel
                        </button>
                        <button onclick="createNewProject()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                            Create Project
                        </button>
                    </div>
                </div>
            `);
            
            // Set up event listeners for the form
            setTimeout(() => {
                const locationSelect = document.getElementById('newProjectLocation');
                const existingPathDiv = document.getElementById('existingPathInput');
                const gitCheckbox = document.getElementById('newProjectGitInit');
                const githubCheckbox = document.getElementById('newProjectGithub');
                const githubSettings = document.getElementById('githubSettings');
                const projectNameInput = document.getElementById('newProjectName');
                const githubRepoInput = document.getElementById('newProjectGithubRepo');
                
                // Toggle existing path input
                locationSelect.addEventListener('change', (e) => {
                    if (e.target.value === 'existing') {
                        existingPathDiv.classList.remove('hidden');
                    } else {
                        existingPathDiv.classList.add('hidden');
                    }
                });
                
                // Toggle GitHub options
                gitCheckbox.addEventListener('change', (e) => {
                    if (!e.target.checked) {
                        githubCheckbox.checked = false;
                        githubCheckbox.disabled = true;
                        githubSettings.classList.add('opacity-50');
                    } else {
                        githubCheckbox.disabled = false;
                        githubSettings.classList.remove('opacity-50');
                    }
                });
                
                // Toggle GitHub settings
                githubCheckbox.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        githubSettings.classList.remove('hidden');
                    } else {
                        githubSettings.classList.add('hidden');
                    }
                });
                
                // Auto-fill GitHub repo name
                projectNameInput.addEventListener('input', (e) => {
                    if (!githubRepoInput.value || githubRepoInput.value === projectNameInput.value.replace(/[^a-z0-9-]/gi, '-').toLowerCase()) {
                        githubRepoInput.value = e.target.value.replace(/[^a-z0-9-]/gi, '-').toLowerCase();
                    }
                });
            }, 100);
        }

        async function createNewProject() {
            const projectName = document.getElementById('newProjectName').value.trim();
            const displayName = document.getElementById('newProjectDisplayName').value.trim();
            const description = document.getElementById('newProjectDescription').value.trim();
            const icon = document.getElementById('newProjectIcon').value.trim().toUpperCase() || 'CODE';
            const location = document.getElementById('newProjectLocation').value;
            const existingPath = document.getElementById('newProjectPath').value.trim();
            const gitInit = document.getElementById('newProjectGitInit').checked;
            const createGithub = document.getElementById('newProjectGithub').checked;
            const githubRepo = document.getElementById('newProjectGithubRepo').value.trim();
            const githubVisibility = document.getElementById('newProjectGithubVisibility').value;
            
            if (!projectName || !displayName) {
                alert('Project name and display name are required');
                return;
            }
            
            const projectData = {
                id: projectName.toLowerCase().replace(/[^a-z0-9-]/g, '-'),
                name: displayName,
                description: description || `${displayName} project`,
                icon: icon,
                location: location,
                path: location === 'existing' ? existingPath : `/Users/kellypellas/DevProjects/${projectName}`,
                gitInit: gitInit,
                github: createGithub ? {
                    repo: githubRepo || projectName,
                    visibility: githubVisibility,
                    username: 'kpellas'
                } : null
            };
            
            try {
                const response = await fetch('/api/projects/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(projectData)
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Failed to create project');
                }
                
                const result = await response.json();
                
                hideModal();
                alert(`Project "${displayName}" created successfully!${result.githubUrl ? `\n\nGitHub repository: ${result.githubUrl}` : ''}`);
                
                // Reload projects and switch to new project
                await loadData();
                document.getElementById('projectSelector').value = projectData.id;
                window.activeProject = projectData.id;
                await loadData();
                
            } catch (error) {
                alert('Failed to create project: ' + error.message);
            }
        }

        function showCreateWorktree() {
            if (!window.activeProject) {
                alert('Please select a project first');
                return;
            }
            
            showModal(`
                <h3 class="text-lg font-semibold mb-4">Create New Worktree</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Branch Name</label>
                        <input id="worktreeName" type="text" class="w-full px-3 py-2 border rounded" 
                            placeholder="feature/my-feature">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Description</label>
                        <input id="worktreeDesc" type="text" class="w-full px-3 py-2 border rounded" 
                            placeholder="Optional description">
                    </div>
                    <div class="flex justify-end space-x-2">
                        <button onclick="hideModal()" class="px-4 py-2 border rounded hover:bg-gray-50">
                            Cancel
                        </button>
                        <button onclick="createWorktree()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                            Create Worktree
                        </button>
                    </div>
                </div>
            `);
        }

        async function createWorktree() {
            const name = document.getElementById('worktreeName').value;
            const desc = document.getElementById('worktreeDesc').value;
            
            if (!name) {
                alert('Please enter a branch name');
                return;
            }
            
            try {
                const res = await fetch(`/api/projects/${activeProject}/worktrees`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        branchName: name,
                        description: desc
                    })
                });
                
                const data = await res.json();
                if (data.success) {
                    hideModal();
                    await loadProjectData(window.activeProject);
                    updateWorktrees();
                    alert(`Worktree created! Frontend: ${data.worktree.frontendPort}, Backend: ${data.worktree.backendPort}`);
                    
                    // If there was a pending sprint assignment, assign it now
                    if (window.pendingSprintAssignment) {
                        const sprintName = window.pendingSprintAssignment;
                        window.pendingSprintAssignment = null;
                        
                        // Wait for worktrees to update, then assign
                        setTimeout(() => {
                            assignSprintToWorktree(sprintName);
                        }, 500);
                    }
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Failed to create worktree: ' + error.message);
            }
        }

        function moveToSprint(itemId, sprintName) {
            const item = window.ideas.items.find(i => i.id === itemId);
            if (!item) return;
            
            if (!sprintName) {
                // Reset the dropdown
                updateIdeas();
                return;
            }
            
            if (sprintName === '__new__') {
                // Create new sprint
                const newSprintName = prompt('Enter new sprint name:');
                if (!newSprintName) {
                    updateIdeas();
                    return;
                }
                
                const description = prompt('Enter sprint description (optional):');
                const startDate = prompt('Enter start date (YYYY-MM-DD):') || new Date().toISOString().split('T')[0];
                const endDate = prompt('Enter end date (YYYY-MM-DD):') || '';
                
                if (!ideas.sprints) ideas.sprints = {};
                ideas.sprints[newSprintName] = {
                    name: newSprintName,
                    description: description || '',
                    start: startDate,
                    end: endDate,
                    goals: [],
                    status: 'active',
                    created: new Date().toISOString()
                };
                
                sprintName = newSprintName;
            }
            
            item.sprint = sprintName;
            item.updated = new Date().toISOString();
            
            fetch(`/api/projects/${activeProject}/ideas`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(ideas)
            }).then(() => {
                updateIssues();
                updateSprints();
                alert(`Moved to ${newSprint}`);
            });
        }

        async function viewSessionPrompt(sessionId, sessionState) {
            try {
                // Enhanced prompt viewing - handles both start and close prompts
                const promptType = sessionState === 'closing' || sessionState === 'completed' ? 'close' : 'start';
                let promptUrl = `/api/sessions/${sessionId}/prompt`;
                
                const res = await fetch(promptUrl);
                const prompt = await res.text();
                
                showModal(`
                    <div class="max-h-96 overflow-y-auto">
                        <h3 class="text-lg font-semibold mb-4 sticky top-0 bg-white">
                            Session ${promptType === 'close' ? 'Close' : 'Start'} Prompt
                        </h3>
                        <pre class="text-xs whitespace-pre-wrap font-mono bg-gray-50 p-4 rounded">${prompt}</pre>
                        <div class="flex justify-end space-x-2 mt-4 sticky bottom-0 bg-white pt-2">
                            <button onclick="hideModal()" class="px-4 py-2 border rounded hover:bg-gray-50">
                                Close
                            </button>
                            <button onclick="copyPrompt('${sessionId}')" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                                Copy to Clipboard
                            </button>
                        </div>
                    </div>
                `);
            } catch (error) {
                alert('Failed to load prompt: ' + error.message);
            }
        }

        async function copyPrompt(sessionId) {
            try {
                const res = await fetch(`/api/sessions/${sessionId}/prompt`);
                const prompt = await res.text();
                
                // Try modern clipboard API first
                try {
                    await navigator.clipboard.writeText(prompt);
                    // Show success toast
                    const toast = document.createElement('div');
                    toast.textContent = '✅ Prompt copied to clipboard!';
                    toast.style.cssText = 'position:fixed;bottom:20px;right:20px;background:#10b981;color:white;padding:10px 20px;border-radius:5px;z-index:10000';
                    document.body.appendChild(toast);
                    setTimeout(() => document.body.removeChild(toast), 2000);
                } catch (clipErr) {
                    // Fallback for older browsers
                    const textArea = document.createElement('textarea');
                    textArea.value = prompt;
                    textArea.style.position = 'fixed';
                    textArea.style.left = '-999999px';
                    document.body.appendChild(textArea);
                    textArea.select();
                    try {
                        document.execCommand('copy');
                        alert('Prompt copied to clipboard!');
                    } catch (e) {
                        alert('Failed to copy. Please copy manually.');
                    }
                    document.body.removeChild(textArea);
                }
            } catch (error) {
                alert('Failed to fetch prompt: ' + error.message);
            }
        }

        // Close modal when clicking overlay
        document.getElementById('modalOverlay').addEventListener('click', (e) => {
            if (e.target.id === 'modalOverlay') {
                hideModal();
            }
        });
    </script>
    <!-- Copyable Modal -->
    <div id="copyModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg max-w-2xl w-full max-h-[80vh] overflow-hidden shadow-xl">
                <div class="flex justify-between items-center p-4 border-b">
                    <h3 id="modalTitle" class="text-lg font-semibold"></h3>
                    <button onclick="closeCopyModal()" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div class="p-4 overflow-y-auto max-h-[60vh]">
                    <pre id="modalContent" class="whitespace-pre-wrap font-mono text-sm bg-gray-50 p-4 rounded select-all"></pre>
                </div>
                <div class="flex justify-end gap-2 p-4 border-t">
                    <button onclick="copyModalContent()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                        Copy to Clipboard
                    </button>
                    <button onclick="closeCopyModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Modal functions
        function showCopyModal(title, content) {
            document.getElementById('modalTitle').textContent = title || 'Information';
            document.getElementById('modalContent').textContent = content;
            document.getElementById('copyModal').classList.remove('hidden');
        }
        
        function closeCopyModal() {
            document.getElementById('copyModal').classList.add('hidden');
        }
        
        async function copyModalContent() {
            const content = document.getElementById('modalContent').textContent;
            try {
                await navigator.clipboard.writeText(content);
                // Show feedback
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = 'Copied!';
                btn.classList.add('bg-green-500');
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.classList.remove('bg-green-500');
                }, 2000);
            } catch (err) {
                console.error('Failed to copy:', err);
            }
        }
        
        // Override alert to use the modal for important messages
        const originalAlert = window.alert;
        window.alert = function(message) {
            // Check if message contains important info that might need copying
            if (message && (message.includes('Failed') || message.includes('Error') || message.includes('Success') || message.length > 200)) {
                showCopyModal('Message', message);
            } else {
                originalAlert(message);
            }
        };
    </script>

</body>
</html>